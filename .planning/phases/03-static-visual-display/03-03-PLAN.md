---
phase: 03-static-visual-display
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - src/minime-card.ts
  - tests/minime-card.test.ts
autonomous: false

must_haves:
  truths:
    - "Card displays the correct room background when entity state matches a configured area"
    - "Card displays pixel art avatar positioned in the room scene"
    - "Card switches room background immediately when entity state changes to a different area"
    - "Card shows 'not detected' visual when entity is unknown (no avatar, empty room or message)"
    - "Card layout scales responsively on mobile devices"
  artifacts:
    - path: "src/minime-card.ts"
      provides: "Complete visual rendering with room backgrounds and avatar"
      contains: "roomBackgrounds"
    - path: "tests/minime-card.test.ts"
      provides: "Tests for room display logic and avatar rendering"
      contains: "room-background"
  key_links:
    - from: "src/minime-card.ts"
      to: "src/assets/rooms.ts"
      via: "import roomBackgrounds"
      pattern: "import.*roomBackgrounds"
    - from: "src/minime-card.ts"
      to: "src/assets/avatar.ts"
      via: "import avatarSprite"
      pattern: "import.*avatarSprite"
    - from: "src/minime-card.ts render()"
      to: "this._entityState"
      via: "Room background selected based on entity state matching area name"
      pattern: "roomBackgrounds\\[.*entityState"
---

<objective>
Integrate pixel art assets into the card renderer to display room backgrounds and avatar based on Bermuda entity state.

Purpose: This is the visual payoff of the entire project — replacing the skeleton text-only render with actual pixel art room scenes and an avatar character. The card becomes visually compelling and functional.
Output: Card renders the correct room background and avatar for the current Bermuda-detected area, with responsive layout.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-static-visual-display/03-01-SUMMARY.md
@.planning/phases/03-static-visual-display/03-02-SUMMARY.md
@src/minime-card.ts
@src/types.ts
@src/assets/rooms.ts
@src/assets/avatar.ts
@tests/minime-card.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace skeleton render with pixel art room display</name>
  <files>src/minime-card.ts</files>
  <action>
Replace the skeleton `render()` method in MiniMeCard with full pixel art rendering.

**Import assets:**
```typescript
import { roomBackgrounds } from './assets/rooms';
import { avatarSprite } from './assets/avatar';
```

**Update render() method:**

The render should produce this structure:
```html
<ha-card>
  <div class="scene-container">
    <!-- Room background as inline SVG or img with data URI -->
    <div class="room-background" .innerHTML=${roomSvg}></div>
    <!-- OR use img tag: -->
    <img class="room-background" src="data:image/svg+xml;base64,${btoa(roomSvg)}" alt="${roomName}" />

    <!-- Avatar overlay positioned in the room -->
    <div class="avatar" .innerHTML=${avatarSprite.idle}></div>
    <!-- OR img tag approach -->

    <!-- Room label overlay -->
    <div class="room-label">${roomName}</div>
  </div>
</ha-card>
```

**Rendering logic:**
1. Get current room from `this._entityState` (the area name from Bermuda, e.g., 'office')
2. Look up room background: `const roomSvg = roomBackgrounds[this._entityState]`
3. If room background exists: render scene with background + avatar
4. If room background doesn't exist but entityState exists: render with a default/fallback background and the room name text
5. If entityState is 'Not detected': render an empty state — show last known room background at reduced opacity (if we have `_lastRoom` tracked) OR show a "not detected" message
6. If error: keep existing error rendering

**Add `_lastRoom` tracking:**
- Add `private _lastRoom?: string` (NOT reactive, just internal state)
- In `set hass()`, before updating `_entityState`, save current room: `if (this._entityState && this._entityState !== 'Not detected') this._lastRoom = this._entityState`
- When 'Not detected', use `_lastRoom` to show the last room background at reduced opacity

**Use Lit's `unsafeSVG` or `unsafeHTML` directive for inline SVG rendering.**
Import: `import { unsafeHTML } from 'lit/directives/unsafe-html.js';`

This is safe because we control the SVG content (it's our own asset module, not user input).

**Update static styles:**

Replace current minimal styles with scene-appropriate CSS:

```css
:host {
  --minime-bg: var(--card-background-color, #fff);
  --minime-text: var(--primary-text-color, #333);
  --minime-secondary: var(--secondary-text-color, #666);
  --minime-error: var(--error-color, #db4437);
  --minime-accent: var(--accent-color, #03a9f4);
}

ha-card {
  background: var(--minime-bg);
  color: var(--minime-text);
  overflow: hidden;
  padding: 0;
}

.scene-container {
  position: relative;
  width: 100%;
  /* 16:10 aspect ratio for pixel art scene */
  padding-bottom: 62.5%;
  overflow: hidden;
}

.room-background {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.room-background svg {
  width: 100%;
  height: 100%;
  display: block;
}

.room-background.faded {
  opacity: 0.3;
  filter: grayscale(0.5);
}

.avatar {
  position: absolute;
  bottom: 15%;
  left: 50%;
  transform: translateX(-50%);
  width: 15%;
  /* Avatar scales proportionally */
}

.avatar svg {
  width: 100%;
  height: auto;
  display: block;
  image-rendering: pixelated;
}

.room-label {
  position: absolute;
  bottom: 4px;
  right: 8px;
  font-size: 0.75em;
  color: var(--minime-secondary);
  text-transform: capitalize;
  background: rgba(0,0,0,0.3);
  padding: 2px 6px;
  border-radius: 3px;
  color: white;
}

.not-detected {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 0.9em;
  color: var(--minime-secondary);
  text-align: center;
}

/* Keep error styles from Phase 2 */
.error { /* existing */ }
.error-icon { /* existing */ }
.error-message { /* existing */ }

/* Responsive: ensure scene doesn't get too tall on wide screens */
@media (min-width: 600px) {
  .scene-container {
    max-height: 300px;
    padding-bottom: 0;
    height: 250px;
  }
}
```

The scene uses relative positioning with percentage-based sizes so it scales naturally on different screen sizes including mobile.
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Run `npm run build` — bundle builds successfully. Visually review that render() handles all states: room found, room not found, not detected, error.</verify>
  <done>Card render() displays room background SVG with avatar overlay. Room switches based on entity state. Not-detected shows faded last room. Responsive CSS scales scene properly.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for visual rendering logic</name>
  <files>tests/minime-card.test.ts</files>
  <action>
Add new test groups to the existing minime-card.test.ts:

**1. Room background selection tests:**
```typescript
describe('Room display', () => {
  beforeEach(() => {
    card.setConfig({ type: 'custom:minime-card', entity: 'device_tracker.bermuda_phone' });
  });

  it('tracks last known room', () => {
    card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'office' } });
    expect((card as any)._lastRoom).toBe('office');
  });

  it('preserves last room when not detected', () => {
    card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'office' } });
    card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'unknown' } });
    expect((card as any)._lastRoom).toBe('office');
    expect((card as any)._entityState).toBe('Not detected');
  });

  it('updates last room on room change', () => {
    card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'office' } });
    card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'kitchen' } });
    expect((card as any)._lastRoom).toBe('kitchen');
  });
});
```

**2. getStubConfig and getConfigElement tests:**
```typescript
describe('Editor integration', () => {
  it('returns stub config with default areas', () => {
    const stub = MiniMeCard.getStubConfig();
    expect(stub).toHaveProperty('areas');
    expect(stub.areas).toContain('office');
  });

  it('returns config element', () => {
    const el = MiniMeCard.getConfigElement();
    expect(el.tagName.toLowerCase()).toBe('minime-card-editor');
  });
});
```

Run all tests to make sure existing tests still pass alongside new ones.

After tests, run `npm run build` to verify final bundle.
  </action>
  <verify>Run `npm test` — all tests pass. Run `npm run build` — bundle builds. Verify test count increased.</verify>
  <done>Tests verify room tracking, last room preservation, stub config, and editor element integration. All tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Pixel art card displaying room backgrounds with avatar based on Bermuda entity state. Visual editor for configuration.</what-built>
  <how-to-verify>
    1. Run `npm run build` to create the production bundle
    2. Copy dist/minime-card.js to your Home Assistant config/www/ directory
    3. Add the card to a dashboard — it should display a pixel art room scene
    4. Verify the visual editor appears when configuring the card (entity picker + area checkboxes)
    5. Change Bermuda device location and verify the room background switches
    6. Verify the card looks reasonable on mobile (responsive scaling)
    7. Check that error states still display properly (remove entity to test)
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 3, or describe any visual/functional issues to address.</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npm test` passes all tests (old + new)
- `npm run build` produces dist/minime-card.js
- Card renders room backgrounds from inline SVG assets
- Card shows avatar positioned in the scene
- Room switches when entity state changes
- Not-detected state shows faded last room or message
- Layout scales on different screen sizes
</verification>

<success_criteria>
- Card displays correct static pixel art background for each room
- Card displays pixel art avatar in the room scene
- Card switches rooms when Bermuda entity state changes
- Responsive layout works on mobile
- Error states still render properly
- All tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/03-static-visual-display/03-03-SUMMARY.md`
</output>
