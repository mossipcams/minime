---
phase: 02-card-foundation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/minime-card.ts
  - tests/minime-card.test.ts
autonomous: true

must_haves:
  truths:
    - "Card displays current area name from Bermuda entity state"
    - "Card shows clear error when Bermuda entity is unavailable"
    - "Card shows clear error when entity state is 'unavailable' (integration disabled)"
    - "Card styling uses HA theme CSS variables for light and dark mode"
    - "Card re-renders only when tracked entity changes, not on every HA state update"
  artifacts:
    - path: "src/minime-card.ts"
      provides: "Complete card with HA integration, theming, and error states"
      contains: "var(--primary-text-color)"
    - path: "tests/minime-card.test.ts"
      provides: "Tests covering error states and entity integration"
      contains: "unavailable"
  key_links:
    - from: "src/minime-card.ts"
      to: "hass.states"
      via: "set hass selective extraction"
      pattern: "hass\\.states\\[this\\._config"
    - from: "src/minime-card.ts render()"
      to: "this._entityState"
      via: "conditional rendering based on entity state"
      pattern: "this\\._entityState"
    - from: "src/minime-card.ts styles"
      to: "HA theme system"
      via: "CSS custom properties"
      pattern: "var\\(--"
---

<objective>
Complete the card's Home Assistant integration with Bermuda entity handling, theme-aware styling, and proper error states.

Purpose: Makes the card functional within Home Assistant -- reading real entity data, handling failure modes gracefully, and respecting the user's chosen theme.
Output: A fully integrated card that reads Bermuda BLE state, shows error messages for failure modes, and styles itself with HA theme variables.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-card-foundation/02-01-SUMMARY.md
@src/types.ts
@src/minime-card.ts
@tests/minime-card.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance entity handling with error states and state detection</name>
  <files>src/minime-card.ts</files>
  <action>
Enhance the `set hass` setter in MiniMeCard to handle Bermuda-specific states:

1. **Entity not found in hass.states:**
   - Set `this._error = 'Entity not found: ${this._config.entity}'`
   - This covers CORE-08 (device not found)

2. **Entity state is 'unavailable':**
   - Set `this._error = 'Bermuda integration is unavailable. Check that the Bermuda BLE integration is enabled.'`
   - This covers CORE-09 (Bermuda integration disabled)

3. **Entity state is 'unknown':**
   - Set `this._error = undefined` (clear error)
   - Set `this._entityState = 'Not detected'`
   - This handles when Bermuda is running but device isn't in any area

4. **Entity state is a valid area name (normal case):**
   - Set `this._error = undefined`
   - Set `this._entityState = entity.state`
   - Bermuda sets the state to the area name (e.g., 'office', 'kitchen')

5. **Optimization — prevent unnecessary re-renders:**
   - Before setting `_entityState`, check if the new value differs from current
   - `if (this._entityState !== entity.state)` then update
   - Same for `_error` — only set if changed
   - Since `_entityState` and `_error` are `@state()`, Lit will re-render only when they change

Enhance `render()` to display error states distinctively:

- Error state: Render inside `<ha-card>` with a warning icon and the error message
  ```
  html`<ha-card header="${this._config.name || 'MiniMe'}">
    <div class="card-content">
      <div class="error">
        <span class="error-icon">!</span>
        <span class="error-message">${this._error}</span>
      </div>
    </div>
  </ha-card>`
  ```

- Normal state: Render with area display
  ```
  html`<ha-card header="${this._config.name || 'MiniMe'}">
    <div class="card-content">
      <div class="room-display">
        <div class="room-label">${this._entityState}</div>
      </div>
    </div>
  </ha-card>`
  ```

This is still a skeleton UI — Phase 3 replaces room-display with pixel art canvas.
  </action>
  <verify>Run `npx tsc --noEmit` — zero errors. Manually inspect that all three error paths (not found, unavailable, unknown) are handled in the hass setter.</verify>
  <done>Hass setter handles entity-not-found, unavailable (Bermuda disabled), unknown (not detected), and normal area states. Render shows appropriate error or area display.</done>
</task>

<task type="auto">
  <name>Task 2: Add theme-aware styles and comprehensive tests</name>
  <files>src/minime-card.ts, tests/minime-card.test.ts</files>
  <action>
Update `static styles` in MiniMeCard to use HA theme CSS variables (CORE-07):

```css
:host {
  --minime-bg: var(--card-background-color, #fff);
  --minime-text: var(--primary-text-color, #333);
  --minime-secondary: var(--secondary-text-color, #666);
  --minime-error: var(--error-color, #db4437);
  --minime-accent: var(--accent-color, #03a9f4);
}

ha-card {
  background: var(--minime-bg);
  color: var(--minime-text);
  overflow: hidden;
}

.card-content {
  padding: 16px;
  min-height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.room-display {
  text-align: center;
  width: 100%;
}

.room-label {
  font-size: 1.4em;
  color: var(--minime-text);
  text-transform: capitalize;
}

.error {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--minime-error);
  padding: 8px;
}

.error-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--minime-error);
  color: white;
  font-weight: bold;
  font-size: 14px;
  flex-shrink: 0;
}

.error-message {
  font-size: 0.9em;
  line-height: 1.3;
}
```

These CSS variables inherit from HA's theme system automatically. When the user switches between light and dark themes, --primary-text-color, --card-background-color etc. update and the card follows.

Add tests to `tests/minime-card.test.ts`:

1. **Error state — entity unavailable:**
   ```
   it('shows error when entity state is unavailable', () => {
     card.setConfig({ type: 'custom:minime-card', entity: 'device_tracker.bermuda_phone' });
     card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'unavailable', ... } });
     expect(card._error).toContain('unavailable');
   });
   ```

2. **Error state — entity not found:**
   ```
   it('shows error when entity does not exist in hass', () => {
     card.setConfig({ type: 'custom:minime-card', entity: 'device_tracker.bermuda_phone' });
     card.hass = mockHass({});
     expect(card._error).toContain('not found');
   });
   ```

3. **Unknown state — not detected:**
   ```
   it('shows not detected when entity state is unknown', () => {
     card.setConfig({ type: 'custom:minime-card', entity: 'device_tracker.bermuda_phone' });
     card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'unknown', ... } });
     expect(card._entityState).toBe('Not detected');
     expect(card._error).toBeUndefined();
   });
   ```

4. **Normal state — area name:**
   ```
   it('extracts area name from entity state', () => {
     card.setConfig({ type: 'custom:minime-card', entity: 'device_tracker.bermuda_phone' });
     card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'office', ... } });
     expect(card._entityState).toBe('office');
     expect(card._error).toBeUndefined();
   });
   ```

5. **Re-render optimization:**
   ```
   it('does not update state when entity value unchanged', () => {
     card.setConfig({ type: 'custom:minime-card', entity: 'device_tracker.bermuda_phone' });
     card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'office', ... } });
     const firstState = card._entityState;
     // Set hass again with same entity state
     card.hass = mockHass({ 'device_tracker.bermuda_phone': { state: 'office', ... } });
     // State reference should be unchanged (no re-render triggered)
     expect(card._entityState).toBe(firstState);
   });
   ```

Create a helper function `mockHass(states)` at the top of the test file that returns a minimal HomeAssistant-shaped object:
```
function mockHass(states: Record<string, { state: string; attributes?: Record<string, unknown> }>): any {
  const fullStates: Record<string, any> = {};
  for (const [id, s] of Object.entries(states)) {
    fullStates[id] = {
      entity_id: id,
      state: s.state,
      attributes: s.attributes || {},
      last_changed: new Date().toISOString(),
      last_updated: new Date().toISOString(),
    };
  }
  return { states: fullStates, themes: { darkMode: false } };
}
```

After tests, run full build to verify everything bundles correctly.
  </action>
  <verify>Run `npm test` — all tests pass (both old and new). Run `npm run build` — bundle builds without errors. Verify the CSS contains `var(--primary-text-color)` and `var(--card-background-color)` in the output bundle.</verify>
  <done>Card uses HA theme CSS variables for all colors. Error states (not found, unavailable, unknown) are tested. Normal state extraction is tested. Re-render optimization is tested. Build succeeds.</done>
</task>

</tasks>

<verification>
- `npm test` passes all tests (config validation + entity states + error handling)
- `npm run build` produces dist/minime-card.js without errors
- Card CSS references HA theme variables: --primary-text-color, --card-background-color, --error-color, --accent-color, --secondary-text-color
- Error messages are user-friendly and mention what to check
</verification>

<success_criteria>
- Card reads Bermuda entity state and displays current area name
- Card shows "Entity not found" error when entity doesn't exist
- Card shows "Bermuda integration unavailable" error when entity state is 'unavailable'
- Card shows "Not detected" when entity state is 'unknown'
- Card uses HA CSS custom properties for theme-aware styling
- All tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-card-foundation/02-02-SUMMARY.md`
</output>
