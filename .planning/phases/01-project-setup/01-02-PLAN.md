---
phase: 01-project-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - vitest.config.ts
  - tests/sample.test.ts
  - rollup.config.mjs

autonomous: true

must_haves:
  truths:
    - "npm test runs Vitest and passes with at least one test"
    - "npm run dev starts Rollup in watch mode and rebuilds on file changes"
    - "npm run build still works after adding test/dev scripts"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Vitest configuration with TypeScript and DOM support"
      contains: "vitest"
    - path: "tests/sample.test.ts"
      provides: "Sample passing test proving framework works"
      contains: "expect"
    - path: "package.json"
      provides: "Updated scripts for test, dev, and build"
      contains: "vitest"
  key_links:
    - from: "vitest.config.ts"
      to: "tsconfig.json"
      via: "TypeScript config reference"
      pattern: "typescript|tsconfig"
    - from: "package.json"
      to: "vitest.config.ts"
      via: "test script using vitest"
      pattern: "vitest"
    - from: "package.json"
      to: "rollup.config.mjs"
      via: "dev script using rollup watch"
      pattern: "rollup.*-w|rollup.*watch"
---

<objective>
Add Vitest testing framework and development watch mode to the project so that `npm test` runs and passes, and `npm run dev` starts Rollup in watch mode for rapid development iteration.

Purpose: Complete the development environment so developers can iterate with instant feedback (watch mode rebuilds on save) and write tests from Phase 2 onward. This is the last piece of build infrastructure before card implementation begins.

Output: Working test runner with sample test, and dev script with watch mode.
</objective>

<execution_context>
@/Users/matt/.claude/get-shit-done/workflows/execute-plan.md
@/Users/matt/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md
@.planning/phases/01-project-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vitest with sample test</name>
  <files>
    vitest.config.ts
    tests/sample.test.ts
    package.json
  </files>
  <action>
    1. Install Vitest and DOM testing dependencies:
       `npm install -D vitest happy-dom`

       Use happy-dom (not jsdom) -- it is lighter weight and sufficient for Lit component testing. Do NOT install @vitest/ui or @vitest/browser yet -- those are optional and not needed for Phase 1.

    2. Create vitest.config.ts in project root:
       ```typescript
       import { defineConfig } from 'vitest/config';

       export default defineConfig({
         test: {
           environment: 'happy-dom',
           include: ['tests/**/*.test.ts'],
           globals: true,
         },
       });
       ```
       Key settings:
       - environment: 'happy-dom' provides DOM APIs for future Lit component tests
       - include pattern matches tests/ directory
       - globals: true enables describe/it/expect without imports

    3. Create tests/ directory and tests/sample.test.ts:
       ```typescript
       describe('MiniMe Card - Build Verification', () => {
         it('should have a working test environment', () => {
           expect(true).toBe(true);
         });

         it('should support DOM APIs via happy-dom', () => {
           const el = document.createElement('div');
           el.textContent = 'MiniMe';
           expect(el.textContent).toBe('MiniMe');
         });

         it('should support TypeScript features', () => {
           interface CardConfig {
             entity: string;
             name?: string;
           }

           const config: CardConfig = { entity: 'person.test' };
           expect(config.entity).toBe('person.test');
           expect(config.name).toBeUndefined();
         });
       });
       ```
       These tests verify: Vitest runs, happy-dom provides DOM, TypeScript interfaces work. They will be replaced by real tests in Phase 2.

    4. Update package.json scripts to add:
       - "test": "vitest run"
       - "test:watch": "vitest"

       Keep the existing "build" script unchanged.

    5. Run `npm test` and verify all 3 tests pass.
  </action>
  <verify>
    - `npm test` exits with code 0
    - Output shows 3 tests passing
    - `cat vitest.config.ts` shows happy-dom environment
  </verify>
  <done>Vitest runs successfully with 3 passing tests covering basic assertions, DOM APIs, and TypeScript features. Test scripts added to package.json.</done>
</task>

<task type="auto">
  <name>Task 2: Add dev watch mode script and verify full toolchain</name>
  <files>
    package.json
    rollup.config.mjs
  </files>
  <action>
    1. Update package.json to add dev script:
       - "dev": "rollup -c rollup.config.mjs -w"

       The -w flag enables Rollup watch mode. When a source file changes, Rollup automatically rebuilds dist/minime-card.js.

    2. Update rollup.config.mjs to detect watch mode correctly. The current config uses `process.env.ROLLUP_WATCH === 'true'` but Rollup sets `process.env.ROLLUP_WATCH` to `'true'` automatically when using -w flag. Verify this works by checking:
       - In watch mode: sourcemaps enabled, terser disabled
       - In build mode: sourcemaps disabled, terser enabled

    3. Verify the full toolchain works end-to-end:
       - `npm run build` -- produces minified dist/minime-card.js (no sourcemap)
       - `npm run dev` -- starts watch mode (verify it starts, then kill it with ctrl+c or timeout)
       - `npm test` -- all tests pass
       - `ls dist/minime-card.js` -- file exists from build

    4. Verify all five SETUP requirements are met:
       - SETUP-01: `npm run build` produces dist/minime-card.js
       - SETUP-02: TypeScript strict + decorators (from Plan 01)
       - SETUP-03: hacs.json exists with correct metadata (from Plan 01)
       - SETUP-04: `npm run dev` starts watch mode
       - SETUP-05: `npm test` passes
  </action>
  <verify>
    - `npm run build` exits 0 and produces dist/minime-card.js
    - `npm run dev` starts and prints "waiting for changes..." or similar (kill after confirming)
    - `npm test` exits 0 with all tests passing
    - `cat package.json | grep -A5 scripts` shows build, dev, test, test:watch scripts
  </verify>
  <done>Dev environment is complete: build produces bundle, watch mode works for rapid iteration, tests pass. All SETUP-01 through SETUP-05 requirements are satisfied.</done>
</task>

</tasks>

<verification>
Run these checks to verify Plan 02 is complete:

1. `npm test` -- exits 0, 3 tests pass
2. `npm run build` -- exits 0, dist/minime-card.js produced
3. `timeout 10 npm run dev || true` -- starts watch mode (exits after timeout, that's fine)
4. `cat package.json | grep vitest` -- vitest is in devDependencies
5. `cat vitest.config.ts | grep happy-dom` -- DOM environment configured
</verification>

<success_criteria>
- SETUP-04: Dev environment with watch mode -- VERIFIED by `npm run dev` starting Rollup watcher
- SETUP-05: Vitest configured and runnable -- VERIFIED by `npm test` passing with sample tests
- All 5 SETUP requirements complete -- Full build toolchain operational
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup/01-02-SUMMARY.md`
</output>
